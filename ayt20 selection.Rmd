---
title: "ayt20 selection"
author: "chike"
date: '2022-07-14'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# load data

```{r}
library(tidyverse)

# ayt20_sindex selection

ayt20_sindex <- read_csv("AYT20_SINDEX.csv") %>%
  janitor::clean_names() %>% 
  select(accession_name:sindex)

# list of checks present in dataset
checks <- c("IITA-TMS-IBA000070","TMEB419","TMS13F1160P0004","TMS14F1036P0007","IITA-TMS-IBA30572","IITA-TMS-IBA980581")

# calculate for checks average 
checks_mean <- ayt20_sindex %>%
  filter(accession_name %in% checks) %>%
  add_row(accession_name = "check_mean", summarise(., across(where(is.numeric), mean))) %>%
  filter(accession_name == "check_mean")

# insert check mean into dataset
ayt20_sindex <- bind_rows(ayt20_sindex,checks_mean)

# dataset for percentage difference against checks average
ayt20_sindex_checkdiff <- ayt20_sindex %>% 
  select(-sindex) %>% 
  mutate(across(where(is.numeric), .fns = ~((./.[accession_name == "check_mean"]-1)*100))) %>% 
  mutate(sindex=ayt20_sindex$sindex) %>% 
  mutate(rank = factor(row_number()))


skimr::skim(ayt20_sindex)
skimr::skim(ayt20_sindex_checkdiff)

# Hmisc::describe(ayt20_sindex)
# Hmisc::describe(ayt20_sindex_checkdiff)
# 
# psych::describe(ayt20_sindex)
# psych::describe(ayt20_sindex_checkdiff)
# 
# summarytools::descr(ayt20_sindex)
# summarytools::descr(ayt20_sindex_checkdiff)
# 
# summarytools::dfSummary(ayt20_sindex)
# summarytools::dfSummary(ayt20_sindex_checkdiff)


# pt_fun <- function(x, )
# 
# map2_df(checks_mean[,-1], ayt20_sindex[,-1], `/`) %>% 
#   -1 * 100 %>% 
#   add_column(accession_name = ayt20_sindex$accession_name, .before = "sprout")

```
# distribution of traits and selection index

```{r }
# ayt20_sindex %>% 
#   pivot_longer(-accession_name, names_to = "traits", values_to = "values") %>% 
#   ggplot(aes(values, fill = traits)) + 
#   geom_dotplot(show.legend = FALSE, alpha = 0.7) +
#   geom_density(show.legend = FALSE, alpha = 0.1) +
#   geom_histogram(show.legend = FALSE, alpha = 0.5) + 
#   facet_wrap(~traits, scales = "free") +
#   theme_bw() +
#   labs(title = "Distribution of Raw Phenotypic Values and Selection Index")

ayt20_sindex %>% 
  pivot_longer(-accession_name, names_to = "traits", values_to = "values") %>% 
  ggplot(aes(traits, values, fill = traits)) +
  geom_violin(alpha = 0.7, color=NA) +
  geom_jitter(alpha = 0.3, width = 0.1) +
  facet_wrap(~traits, scales = "free") +
  theme_bw() +
  theme(legend.position="none") +
  labs(title = "Distribution of Raw Phenotypic Values and Selection Index")

```
# distribution of traits values  percent difference from check average 

```{r}
# ayt20_sindex_checkdiff %>% 
#   select(-c(l,a,b, sindex)) %>% 
#   pivot_longer(-c(accession_name,rank), names_to = "traits", values_to = "values") %>%
#   ggplot(aes(values, fill = traits)) + 
#   geom_dotplot(show.legend = FALSE, alpha = 0.7) +
#   geom_density(show.legend = FALSE, alpha = 0.1) +
#   geom_histogram(show.legend = FALSE, alpha = 0.5) +
#   scale_x_continuous(labels = function(x) paste0(x, "%")) +
#   facet_wrap(~traits, scales = "free") +
#   theme_bw() +
#   labs(title = "Distribution of Raw Phenotypic Values Difference from Check Average (%)")

ayt20_sindex_checkdiff %>% 
  select(-c(l,a,b, sindex)) %>% 
  pivot_longer(-c(accession_name,rank), names_to = "traits", values_to = "values") %>%
   ggplot(aes(traits, values, fill = traits)) +
  geom_violin(alpha = 0.7, color=NA) +
  geom_jitter(alpha = 0.3, width = 0.1) +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  facet_wrap(~traits, scales = "free") +
  theme_bw() +
  theme(legend.position="none") +
  labs(title = "Distribution of Raw Phenotypic Values Difference from Check Average (%)")

```


# barplot visualization our top 10 percentile with 

```{r}
ayt20_sindex_checkdiff %>% 
  select(-c(l,a,b, rtwt)) %>% 
  select(accession_name,fyld,dyld,dm,shtwt,everything()) %>% 
  pivot_longer(-c(accession_name,rank,sindex), names_to = "traits", values_to = "values") %>%
  
 # group_by(traits) %>%
  top_frac(.1,sindex) %>%
  #ungroup() %>%
  
  # mutate(traits = fct_reorder(traits, values)) %>%
  ggplot(aes(fct_inorder(traits), values)) +
  geom_col(aes(fill = values), stat = "identity", color=alpha("black",.3)) +
  # facet_grid( vars(fct_inorder(traits)), vars(accession_name), scales = "free", space = "free") +
  # geom_hline(aes(yintercept = 0, alpha = 0.1, color="blue")) +
  geom_text(aes(label= round(values,2)), position = position_stack(vjust = 0.5)) +
  # geom_text(aes(label=round(values, 2)), vjust=0) +
  scale_fill_gradient2(low = "red", mid = "white", high = "green", midpoint= 0) +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  facet_wrap(~accession_name, ncol = 1, strip.position = "right", scales = "free") +
  labs(x = "traits", y = "percent difference from checks_mean") +
  theme_bw() 
  
ggsave("t10p_barplot1.pdf", width=20, height=20)

```
# table include check_mean values

```{r}
library(knitr)
library(kableExtra)

kbl(cbind(ayt20_sindex)) %>%
  # add_header_above(c("a" = 5, "b" = 18)) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "200px")

```
# table for percent comparism to check_mean values

```{r}
kbl(cbind(ayt20_sindex_checkdiff)) %>%
  # add_header_above(c("a" = 5, "b" = 18)) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "200px")

```
# heatmap

```{r out.width="100%"}
library(superheat)

a2h <- ayt20_sindex %>%
  # arrange(desc(sindex)) %>%
  column_to_rownames("accession_name")

dm <- paste(a2h$dm, "dm")
sindex <- paste(a2h$sindex, "sindex")

# set the text colors 
# identify all scaled values that fall below -0.3
ayt20.col <- scale(a2h) < -0.3
# set all values that satisfy the condition to "white"
ayt20.col <- gsub("TRUE", "white", ayt20.col)
# set all values that do not satisfy the condition to "black"
ayt20.col <- gsub("FALSE", "black", ayt20.col)
# convert to matrix
ayt20.col <- matrix(ayt20.col, ncol = ncol(a2h))

ayt20.size <- scale(a2h) + 2


set.seed(2016113)
superheat(a2h,
          # retain original order of rows/cols
          # pretty.order.rows = TRUE,
          # pretty.order.cols = TRUE,
          # scale the matrix columns
          scale = TRUE,
          # order the rows by selection index
          order.rows = order(ayt20_sindex$sindex),
          
          # change the color
          # heat.col.scheme = "blue",
          # change the color (#b35806 = brown and #542788 = purple)
          heat.pal = c("red", "yellow", "green"),
          # Color transitions
          heat.pal.values = c(0, 0.5, 1),
          # # color limits
          # heat.lim = c(-1, 2),
          # heat.na.col = "white", # na values
          # add row dendrogram
          row.dendrogram = TRUE,
          # add colun dendrogram
          col.dendrogram = TRUE,
          
          # clustering methods
          # clustering.method = "hierarchical",
          # generate column clusters
          # n.clusters.rows = 4,
          # left.label = 'variable'
          
          # cluster by sindex
          # membership.rows = fct_inorder(sindex)
          
          # plot title
          title = "Superheat for ayt20 \n selection index",
          title.size = 5,
          # row title
          row.title = "accession_name",
          row.title.size = 5,
          # col title
          column.title = "traits",
          column.title.size = 5,
          
          # adjacent plots
          # # add selection index as a scatterplot next to the rows
          # yr = a2h$sindex,
          # yr.axis.name = "selection index"
          
          # add text matrix
          X.text = round(as.matrix(a2h), 1),
          X.text.col = ayt20.col,
          #X.text.size = 4,
          X.text.size = ayt20.size,
          # X.text.angle = 12,
          
          # change the size of the labels
          left.label.size = 0.4,
          bottom.label.size = 0.24,
          
          # change the size of the label text
          left.label.text.size = 3,
          bottom.label.text.size = 4,
          
          # # change the color of the labels
          # left.label.col = "white",
          # bottom.label.col = c("#b3e2cd","#fdcdac","#e5d8bd"),
          
          # change the color of the label text
          left.label.text.col = "red",
          bottom.label.text.col = c("orange","cornflowerblue"),
          
          # change the angle of the label text
          bottom.label.text.angle = 90,
          left.label.text.alignment = "center",
          bottom.label.text.alignment = "center",
          
          # # remove the grid
          # grid.hline = FALSE,
          # grid.vline = FALSE,
          
          # # change the grid color and size
          # grid.hline.col = "white",
          # grid.vline.col = "white",
          # grid.hline.size = 2,
          # grid.vline.size = 2,
          
          # # cluster the heatmap
          # n.clusters.rows = 3,
          # left.label = "variable",
          # n.clusters.cols = 2,
          # bottom.label = "variable"
          
          # # remove the legend
          # legend = FALSE,
          
          #  # make the legend bigger
          # legend.height = 0.5,
          # legend.width = 2,
          # legend.text.size = 20,
          
          # # cluster by gears
          # membership.rows = sindex,
          # 
          # # place each variable in its own cluster
          # membership.cols = 1:ncol(a2h),
          # bottom.label = "variable",
          # 
          # # smooth the heatmap within clusters
          # smooth.heat = TRUE
          )
          


# extracting the clusters
superheatmap <- superheat(a2h,
                          # scale the matrix columns
                          scale = TRUE,
                          # generate three column clusters
                          n.clusters.rows = 3,
                          left.label = 'variable',
                          print.plot = F)

# extract the clusters
superheatmap$membership.rows


superheat(dplyr::select(a2h, -sindex, -fyld), 
          # scale the variables/columns
          scale = T,
          
          # cluster the rows
          membership.rows = paste(a2h$fyld, "fyld"),
          left.label = "variable",
          
          # change the size of the label text
          left.label.text.size = 2.2,
          bottom.label.text.size = 4,
          
          # add selection index as a scatterplot next to the rows
          yr = a2h$sindex,
          yr.axis.name = "selection index",
          yr.obs.col = rep("paleturquoise4", nrow(a2h)),
          yr.point.size = 4
          )

# set a color vector
print_col_checks <- a2h %>% 
  mutate(row_number = row_number()) %>% 
 .[checks,] #%>%
 #  select(row_number) %>% 
 #  as.vector() 

point.col <- rep("wheat3", nrow(a2h))
# color checks
point.col[print_col_checks[c(1:ncol(print_col_checks)),13]] <- "red"

# the side plot here highlights the checks in red colour 
# plot a super heatmap
superheat(dplyr::select(a2h, -sindex), 
          # scale the variables/columns
          scale = T,
          # order the rows by selection index
          order.rows = order(ayt20_sindex$sindex),
          
          # change the size of the label text
          left.label.text.size = 2.2,
          bottom.label.text.size = 4,

          # add selection index as a scatterplot next to the rows
          yr = a2h$sindex,
          yr.axis.name = "selection index",
          # change the color of the points
          yr.obs.col = point.col,
          yr.point.size = 4)

# plot a super heatmap
superheat(dplyr::select(a2h, -sindex), 
          # scale the variables/columns
          scale = T,
          # order the rows by selection index
          order.rows = order(ayt20_sindex$sindex),

          # # add selection index as a scatterplot next to the rows
          # yr = a2h$sindex,
          # yr.axis.name = "selection index",
          # # change the color of the points
          # yr.obs.col = point.col,
          # yr.point.size = 4
          
          # # add selection index as a line plot next to the rows
          # yr =a2h$sindex,
          # yr.axis.name = "selection index",
          # yr.plot.type = "line",
          # # order the rows by mpg
          # order.rows = order(a2h$sindex)
          
          # # loess curve
          # # add selection index as a smoothed line plot next to the rows
          # yr = a2h$sindex,
          # yr.axis.name = "selection index",
          # yr.plot.type = "smooth",
          # # change the line thickness and color
          # yr.line.size = 4,
          # yr.line.col = "red4",
          # # order the rows by b
          # order.rows = order(a2h$b)
          
          # # linear regression line
          # # add selection index as a smoothed line plot  next to the rows
          # yr = a2h$sindex,
          # yr.axis.name = "selection index",
          # yr.plot.type = "smooth",
          # smoothing.method = "lm",
          # # change the line thickness and color
          # yr.line.size = 4,
          # yr.line.col = "plum4",
          # # order the rows by b
          # order.rows = order(a2h$b)
          
          # # scatterplot with connecting line plot
          # # add selection index as a scatter line plot next to the rows
          # yr = a2h$sindex,
          # yr.axis.name = "selection index",
          # yr.plot.type = "scatterline",
          # # change the line color
          # yr.line.col = "tomato3",
          # yr.obs.col = rep("orange", nrow(a2h)),
          # yr.point.size = 4,
          # # order the rows by b
          # order.rows = order(a2h$b)
          
          # # scatterplot with smooth line
          # # add selection index as a scatter smoothed plot next to the rows
          # yr = a2h$sindex,
          # yr.axis.name = "selection index",
          # yr.plot.type = "scattersmooth",
          # # change the line color
          # yr.line.col = "tomato3",
          # yr.obs.col = rep("orange", nrow(a2h)),
          # # order the rows by b
          # order.rows = order(a2h$b)
          
          # # add selection index as a barplot next to the rows
          # yr = a2h$sindex,
          # yr.axis.name = "selection index",
          # yr.plot.type = "bar",
          # # set bar colors
          # yr.bar.col = "black",
          # yr.cluster.col = c("beige", "white", "beige")
          
          # change the size of the label text
          left.label.text.size = 3,
          bottom.label.text.size = 4,
          
          # change the size of the labels
          left.label.size = 0.3,
          # bottom.label.size = 0.24,
          
          # add selection index as a scatterplot next to the rows
          yr = a2h$sindex,
          yr.axis.name = "selection index",
          yr.plot.size = 0.2,
          # yr.lim = c(0, 60),
          
          # add correlation between each variable and selection index
          yt = cor(a2h)[-12,"sindex"],
          yt.plot.type = "bar",
          yt.axis.name = "Correlation with \n selection index",
          #yt.lim = c(-1.5, 1)
          # yt.axis.size = 14,
          yt.axis.name.size = 8,
          yt.plot.size = 0.35
          )


library(dplyr)
sindex.per.cluster <- a2h %>% 
  group_by(b) %>% 
  summarize(sindex.avg = mean(sindex)) %>% 
  select(sindex.avg) %>%
  unlist

# plot a super heatmap
superheat(dplyr::select(a2h, -sindex, -b), 
          # scale the variables/columns
          scale = T,
          
          # cluster the rows
          membership.rows = paste(a2h$b, "b"),
          left.label = "variable",
          
          # change the size of the label text
          left.label.text.size = 3,
          bottom.label.text.size = 4,
          
          # change the size of the labels
          left.label.size = 0.3,
          # bottom.label.size = 0.24,
          
          # boxplot
          # add sindex per cluster as a boxplot
          yr = a2h$sindex,
          yr.axis.name = "selection index",
          yr.plot.type = "boxplot")


# # best way to save our superheat plot
# 
# png("superheat.png", height = 900, width = 800)
# superheat(X = mtcars, scale = T)
# dev.off()


```

# load image from image folder

```{r  out.width = "90%", echo=FALSE, fig.align='center',fig.cap = selistnam}
library(tidyverse)
library(jpeg)

# opts_chunk$set(echo = FALSE,
#                out.width = "75%",
#                fig.align = "center")
# 
img_path <- "C:/Users/a.van.doorn/Desktop/iita_data/ayt20 selection/21.GS.C4B.AYT.20.IB/photos/21.GS.C4B.AYT.20.IB_Root/"

# imglist <- list.files(img_path, pattern=NULL, all.files=FALSE,
#            full.names=FALSE)

# df %>%
#   top_n() 

selistnam <- ayt20_sindex$accession_name[-21]

# selist <- str_subset(imglist,selistnam)

# for(i in selist){
#   knitr::include_graphics(path = as.character(paste0(img_path, i, sep = "")))
# }
# 


imglist2 <- list.files(img_path, pattern=paste0(selistnam,collapse = "|"), all.files=FALSE,
                      full.names=TRUE)

knitr::include_graphics(imglist2)



```
